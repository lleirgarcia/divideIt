# divideIt - Uso interno (solo localhost)
# Opción A: Puertos directos → http://localhost:18080 (front) y :18081 (back)
# Opción B: Nombre en la web → añade en /etc/hosts: 127.0.0.1 divideit.local
#           y usa http://divideit.local (nginx en puerto 80; DIVIDEIT_HOST=divideit.local en .env)

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: divideit-backend-internal
    ports:
      - "127.0.0.1:${BACKEND_PORT:-18081}:3051"
    environment:
      - NODE_ENV=production
      - PORT=3051
      - FRONTEND_URL=${DIVIDEIT_PUBLIC_URL:-http://127.0.0.1:18080}
      - LOG_LEVEL=info
      # Google Drive: valores desde .env en la raíz o export (no poner secretos aquí)
      - GOOGLE_DRIVE_CLIENT_ID=${GOOGLE_DRIVE_CLIENT_ID}
      - GOOGLE_DRIVE_CLIENT_SECRET=${GOOGLE_DRIVE_CLIENT_SECRET}
      - GOOGLE_DRIVE_REDIRECT_URI=${GOOGLE_DRIVE_REDIRECT_URI:-http://127.0.0.1:18081/api/google-drive/oauth/callback}
      - GOOGLE_DRIVE_REFRESH_TOKEN=${GOOGLE_DRIVE_REFRESH_TOKEN}
    volumes:
      - divideit-uploads:/app/uploads
      - divideit-processed:/app/processed
      - divideit-logs:/app/logs
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3051/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)}).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - divideit-internal

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        # Con nombre (divideit.local): DIVIDEIT_PUBLIC_URL=http://divideit.local en .env y rebuild
        NEXT_PUBLIC_API_URL: ${DIVIDEIT_PUBLIC_URL:-http://127.0.0.1:18081}
    container_name: divideit-frontend-internal
    ports:
      - "127.0.0.1:${FRONTEND_PORT:-18080}:3050"
    environment:
      - NODE_ENV=production
      - NEXT_PUBLIC_API_URL=${DIVIDEIT_PUBLIC_URL:-http://127.0.0.1:18081}
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - divideit-internal

  # Proxy en puerto 80 para acceder con un nombre (ej. http://divideit.local)
  nginx:
    image: nginx:alpine
    container_name: divideit-nginx-internal
    ports:
      - "127.0.0.1:${NGINX_PORT:-80}:80"
    volumes:
      - ./nginx/internal.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - backend
      - frontend
    restart: unless-stopped
    networks:
      - divideit-internal

volumes:
  divideit-uploads:
  divideit-processed:
  divideit-logs:

networks:
  divideit-internal:
    driver: bridge
